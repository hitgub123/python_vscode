# 基本設計書

## 1. ドキュメント概要
本基本設計書は、出退勤システムの要件に基づき、システムの基本設計を定義するものである。日本IT業界の標準的な規範に従い、明確かつ構造化された記述を行う。

## 2. システム概要
本システムは、従業員の出退勤時刻を正確に記録・管理するための出退勤システムである。主な機能として、ICカードやスマートフォンアプリを用いた打刻機能、および管理者による打刻記録の管理機能を提供し、一般従業員および管理職が利用することを想定している。

## 3. 要件定義
### 3.1 要件一覧
| ID       | 分類             | 要件名       | 概要                                                                 | 利用者       |
|----------|------------------|--------------|----------------------------------------------------------------------|--------------|
| **req-006**  | **出退勤記録管理**   | **打刻修正**   | **管理職は、従業員の打刻漏れや誤った打刻記録を、理由を付記した上で修正できる。** | **管理職**   |

## 4. 機能設計
### 4.2 打刻修正機能 (req-006)
#### 4.2.1 機能概要
管理職が、配下の従業員の打刻記録（出社/退社時刻）に誤りや漏れがあった場合に、Web管理画面から修正を行う機能を提供する。修正時には必ず理由の入力が必須であり、修正履歴はすべて記録され、監査証跡として利用できる。

#### 4.2.2 入力仕様
- **検索条件**
  - 対象従業員（従業員IDまたは氏名で検索）
  - 対象期間（年月日～年月日）
- **修正内容**
  - 修正対象の打刻記録
  - 修正後の打刻日時（YYYY-MM-DD HH:MM）
  - 修正後の打刻種別（出社/退社）
  - 修正理由（必須入力、テキスト形式）

#### 4.2.3 出力仕様
- **画面表示**
  - 検索条件に合致した従業員の打刻履歴一覧を表示。
  - 修正完了後、処理結果（成功/失敗）をメッセージで表示。
  - 修正された記録には、修正済みであることがわかるアイコンや印を表示。
- **通知**
  - 打刻記録が修正された場合、対象の一般従業員にメールまたはアプリ内通知でその旨を通知する。（通知内容：修正前の時刻、修正後の時刻、修正者、修正理由）

#### 4.2.4 処理フロー
1. 管理職がWeb管理画面にログインし、「打刻修正」メニューを選択する。
2. システムが、管理職の権限（配下の従業員など）を確認する。
3. 管理職が、修正対象の従業員と期間を指定して検索を実行する。
4. システムが、指定された条件の打刻履歴をデータベースから取得し、一覧表示する。
5. 管理職が、一覧から修正したい打刻記録を選択し、修正後の日時と修正理由を入力して「更新」ボタンを押下する。
6. システムが入力内容の妥当性チェック（日時の形式、理由の入力有無など）を行う。
7. 妥当性チェックOKの場合、システムは打刻履歴テーブル(T_ATTENDANCE_LOG)を更新し、打刻修正履歴テーブル(T_ATTENDANCE_CORRECTION_HISTORY)に修正内容を記録する。
8. システムが、対象従業員へ修正完了通知を送信する。
9. 画面に処理完了メッセージを表示する。

#### 4.2.5 エラー処理
- **権限エラー**：管理権限のないユーザーがアクセスした場合、「アクセス権がありません」等のエラーメッセージを表示し、トップページへリダイレクトする。
- **入力エラー**：修正理由が未入力の場合や、日時の形式が不正な場合、「修正理由を入力してください」「正しい日時を入力してください」等のエラーメッセージを表示する。
- **データ不整合**：修正対象のデータが存在しない、または更新中に他者によって変更された場合、排他制御を行い、「対象データは更新されました。再度検索してください」等のメッセージを表示する。

## 5. データ設計
### 5.1 データベース構造
#### 5.1.1 打刻履歴テーブル (T_ATTENDANCE_LOG)
_(変更なし)_
| 項目名            | データ型       | 説明                              | 主キー |
|-------------------|----------------|-----------------------------------|--------|
| log_id            | BIGINT         | 打刻ログID（自動採番）           | ○      |
| employee_id       | VARCHAR(10)    | 従業員ID                         |        |
| timestamp         | DATETIME       | 打刻時刻（JST）                  |        |
| attendance_type   | VARCHAR(2)     | 打刻種別（出社:01/退社:02）     |        |
| device_type       | VARCHAR(2)     | デバイス種別（IC:01/アプリ:02）  |        |

#### 5.1.2 【新規】打刻修正履歴テーブル (T_ATTENDANCE_CORRECTION_HISTORY)
修正の監査証跡を確保するために、修正履歴を別テーブルで管理する。
| 項目名                 | データ型       | 説明                                   | 主キー |
|------------------------|----------------|----------------------------------------|--------|
| correction_id          | BIGINT         | 修正履歴ID（自動採番）                | ○      |
| log_id                 | BIGINT         | 修正対象の打刻ログID (FK)             |        |
| modified_by_employee_id| VARCHAR(10)    | 修正を行った管理者の従業員ID           |        |
| before_timestamp       | DATETIME       | 修正前の打刻時刻                       |        |
| after_timestamp        | DATETIME       | 修正後の打刻時刻                       |        |
| correction_reason      | VARCHAR(255)   | 修正理由                               |        |
| correction_timestamp   | DATETIME       | 修正操作が行われた日時                 |        |

## 6. インターフェース設計
### 6.1 外部インターフェース
_(本機能における新規・変更なし)_

### 6.2 内部インターフェース
- **サーバー間通信**
  - プロトコル：HTTPS
  - データ形式：JSON
  - エンドポイント例：
    - POST /api/attendance/log（打刻データ登録）
    - **【新規】GET /api/management/attendance/logs**（管理者向け打刻履歴検索）
    - **【新規】PUT /api/management/attendance/logs/{log_id}**（管理者による打刻記録修正）

## 7. 非機能要件
### 7.1 性能
- 打刻処理：1秒以内に完了
- 同時打刻：最大500人/分
- **【新規】管理者画面での打刻履歴検索：1ヶ月分のデータ検索が3秒以内に完了**

### 7.2 可用性
_(変更なし)_

### 7.3 セキュリティ
- データ暗号化：TLS 1.3
- 認証：多要素認証（アプリの場合）
- ログ監視：不正アクセス検知
- **【新規】アクセス制御：管理職ロールを持つユーザーのみが打刻修正機能にアクセス可能（Role-Based Access Control）**
- **【新規】監査ログ：誰が、いつ、どの記録を、どのように修正したかをすべて記録する（打刻修正履歴テーブルで実現）**

## 8. テスト計画
### 8.1 単体テスト
_(既存テスト項目に加え、以下を追加)_
- 打刻修正画面の入力バリデーション（理由必須、日時形式）が正しく機能すること。
- 修正データが打刻修正履歴テーブルに正しく保存されること。

### 8.2 結合テスト
_(既存テスト項目に加え、以下を追加)_
- 管理者が検索、修正、保存の一連の操作を正常に完了できること。
- 打刻記録の修正後、対象従業員に正しく通知が送信されること。

### 8.3 シナリオテスト
- 一般従業員アカウントで管理画面にアクセスしようとし、権限エラーで弾かれることを確認する。
- 管理者が配下ではない従業員の打刻を修正しようとし、操作が失敗することを確認する。

## 9. 運用・保守
### 9.1 運用体制
_(変更なし)_

### 9.2 保守内容
_(変更なし)_

### 9.3 監査
- **【新規】月次で打刻修正履歴の監査を実施し、不審な修正がないかを確認する運用を定める。**

## 10. 付録
### 10.1 用語集
- 打刻：出社または退社時刻を記録する行為
- ICカード：NFC対応の従業員証
- アプリ：出退勤管理用スマートフォンアプリケーション
- **【新規】打刻修正：管理者によって従業員の打刻記録を修正する行為。**

### 10.2 参考資料
- 日本IT業界標準設計書テンプレート（JISA）
- 出退勤システム要件定義書（2025年6月版）

--- END OF FILE 基本設計書_req-006_打刻修正.md ---