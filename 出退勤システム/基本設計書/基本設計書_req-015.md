# 基本設計書

## 1. ドキュメント概要
本基本設計書は、出退勤システムの要件に基づき、システムの基本設計を定義するものである。日本IT業界の標準的な規範に従い、明確かつ構造化された記述を行う。

## 2. システム概要
本システムは、従業員の出退勤時刻を正確に記録・管理するための出退勤システムである。主な機能として、ICカードやスマートフォンアプリを用いた打刻機能を提供し、一般従業員、管理職、人事部門が利用することを想定している。

## 3. 要件定義
### 3.1 要件一覧
| ID       | 分類             | 要件名             | 概要                                                                                                          | 利用者             |
|----------|------------------|-------------------|--------------------------------------------------------------------------------------------------------------|--------------------|
| req-001  | 出退勤記録管理   | 出退勤打刻          | 従業員は、指定された手段（ICカード、スマートフォンアプリなど）を用いて、自身の出社時刻および退社時刻を正確に記録できる。                               | 一般従業員         |
| req-015  | 残業管理         | 残業超過アラート     | 規定（例：36協定の限度時間）を超える残業が発生した場合、システムは管理職および人事部門にアラートを発する。                                               | 管理職, 人事部門     |

## 4. 機能設計
### 4.1 出退勤打刻機能 (req-001)
#### 4.1.1 機能概要
従業員がICカードまたはスマートフォンアプリを使用して、出社および退社時刻を記録する機能を提供する。打刻データはリアルタイムでサーバーに送信され、正確な時刻管理を行う。

#### 4.1.2 入力仕様
- **ICカード打刻**
  - カードリーダーにICカードをかざす。
  - カードIDと打刻時刻（出社/退社）をシステムに送信。
- **スマートフォンアプリ打刻**
  - アプリ上で「出社」または「退社」ボタンを押下。
  - ユーザー認証（ログインID、パスワード、または生体認証）後、打刻時刻を送信。
- **共通**
  - 打刻時刻：システム時刻（JST）を基準に記録。
  - 打刻種別：出社/退社を識別。

#### 4.1.3 出力仕様
- 打刻完了後、利用者に以下を通知：
  - 打刻時刻
  - 打刻種別（出社/退社）
  - 処理結果（成功/失敗）
- 通知方法：
  - ICカード：カードリーダー画面表示および音声通知
  - スマートフォンアプリ：プッシュ通知および画面表示

#### 4.1.4 処理フロー
1. 利用者がICカードまたはアプリで打刻操作を行う。
2. システムが利用者の認証を行う（カードIDまたはログイン情報）。
3. 認証成功後、打刻時刻と種別をサーバーに送信。
4. サーバーがデータをデータベースに保存。
5. 利用者に処理結果を通知。

#### 4.1.5 エラー処理
- **認証失敗**：エラーメッセージを表示（例：「カードが無効です」「ログイン情報が正しくありません」）。
- **通信エラー**：オフラインモードで一時保存し、後で同期。
- **時刻異常**：システム時刻が取得できない場合、エラーログを記録し管理者通知。

### 4.2 残業超過アラート機能 (req-015)
#### 4.2.1 機能概要
従業員の残業時間が規定の時間を超過した場合、管理職および人事部門にアラートを発信する機能を提供する。アラートは、メールやシステム内の通知を通じて行われる。

#### 4.2.2 入力仕様
- **残業時間算出**：出退勤データに基づき、従業員ごとの残業時間を算出。
- **規定時間設定**：36協定に基づいた残業時間の上限値を設定（柔軟に変更可能）。
- **アラート閾値設定**：アラートを発信する残業時間閾値を設定（例：上限時間の80%）。

#### 4.2.3 出力仕様
- **アラート通知**：
  - 対象者：管理職、人事部門
  - 内容：従業員名、超過時間、超過理由（必要に応じて）、アラート発生日時
  - 方法：メール通知、システム内通知
- **アラートログ**：アラート発生履歴を記録し、管理者が確認できるようにする。

#### 4.2.4 処理フロー
1. システムは、従業員の出退勤データから残業時間を算出する（日次、週次、月次）。
2. 算出された残業時間と、設定された規定時間およびアラート閾値を比較する。
3. 残業時間がアラート閾値を超過した場合、アラート通知を生成する。
4. 生成されたアラート通知を、対象者（管理職、人事部門）に送信する。
5. アラート発生履歴をアラートログに記録する。

#### 4.2.5 エラー処理
- **データ不足**：出退勤データが不足している場合、エラーログを記録し、管理者に通知する。
- **設定不備**：規定時間やアラート閾値が設定されていない場合、エラーログを記録し、管理者に通知する。
- **通知失敗**：メール送信に失敗した場合、エラーログを記録し、再送信を試みる。

## 5. データ設計
### 5.1 データベース構造
#### 5.1.1 打刻履歴テーブル (T_ATTENDANCE_LOG)
| 項目名            | データ型       | 説明                              | 主キー |
|-------------------|----------------|-----------------------------------|--------|
| log_id            | BIGINT         | 打刻ログID（自動採番）           | ○      |
| employee_id        | VARCHAR(10)    | 従業員ID                         |        |
| timestamp         | DATETIME       | 打刻時刻（JST）                  |        |
| attendance_type   | VARCHAR(2)     | 打刻種別（出社:01/退社:02）     |        |
| device_type       | VARCHAR(2)     | デバイス種別（IC:01/アプリ:02）  |        |

#### 5.1.2 残業時間テーブル (T_OVERTIME)
| 項目名            | データ型       | 説明                                    | 主キー |
|-------------------|----------------|----------------------------------------|--------|
| overtime_id      | BIGINT         | 残業時間ID（自動採番）                | ○      |
| employee_id        | VARCHAR(10)    | 従業員ID                               |        |
| target_date      | DATE           | 対象日                                  |        |
| overtime_hours   | DECIMAL(5,2)   | 残業時間（時間）                       |        |
| reason             | VARCHAR(255)   | 残業理由（必要に応じて）               |        |

#### 5.1.3 アラートログテーブル (T_ALERT_LOG)
| 項目名            | データ型       | 説明                                   | 主キー |
|-------------------|----------------|---------------------------------------|--------|
| alert_id          | BIGINT         | アラートログID（自動採番）           | ○      |
| employee_id        | VARCHAR(10)    | 従業員ID                              |        |
| alert_timestamp    | DATETIME       | アラート発生日時                      |        |
| alert_type        | VARCHAR(50)    | アラート種別（残業超過）              |        |
| detail             | TEXT           | アラート詳細                          |        |
| status            | VARCHAR(20)    | ステータス (未対応/対応済)             |        |

## 6. インターフェース設計
### 6.1 外部インターフェース
- **ICカードリーダー**
  - プロトコル：NFC（FeliCa対応）
  - データ形式：カードID（16バイト）
- **スマートフォンアプリ**
  - OS：iOS 15以上、Android 10以上
  - API：RESTful API（JSON形式）
  - 認証：JWTトークン
- **メールサーバー**
  - プロトコル：SMTP
  - データ形式：テキスト形式

### 6.2 内部インターフェース
- **サーバー間通信**
  - プロトコル：HTTPS
  - データ形式：JSON
  - エンドポイント例：
    - POST /api/attendance/log（打刻データ登録）
    - GET /api/overtime/{employee_id}/{date} (残業時間取得)
    - POST /api/alert/send (アラート送信)

## 7. 非機能要件
### 7.1 性能
- 打刻処理：1秒以内に完了
- 同時打刻：最大500人/分
- アラート生成：日次処理として、翌朝9時までに完了

### 7.2 可用性
- 稼働率：99.9%
- メンテナンス時間：毎月第2日曜 0:00-3:00

### 7.3 セキュリティ
- データ暗号化：TLS 1.3
- 認証：多要素認証（アプリの場合）
- ログ監視：不正アクセス検知
- メール送信：SPF/DKIM対応

## 8. テスト計画
### 8.1 単体テスト
- 各コンポーネント（ICカード認証、アプリ認証、データ保存、残業時間算出、アラート通知）の動作確認。
### 8.2 結合テスト
- ICカードとアプリの打刻データが同一DBに正しく保存されることを確認。
- 残業時間が正しく算出され、アラートが正常に送信されることを確認。
### 8.3 負荷テスト
- 500人同時打刻時のレスポンスタイムを測定。
- 大量の残業データに対するアラート生成処理の性能を評価。

## 9. 運用・保守
### 9.1 運用体制
- サポート窓口：平日9:00-17:00
- 障害対応：24時間365日（緊急時）
### 9.2 保守内容
- 月次パッチ適用
- 年次システムアップデート
- 残業時間算出ロジックの調整（法改正対応など）

## 10. 付録
### 10.1 用語集
- 打刻：出社または退社時刻を記録する行為
- ICカード：NFC対応の従業員証
- アプリ：出退勤管理用スマートフォンアプリケーション
- 36協定：労働基準法第36条に基づく労使協定
- 残業時間：所定労働時間を超えて労働した時間

### 10.2 参考資料
- 日本IT業界標準設計書テンプレート（JISA）
- 出退勤システム要件定義書（2025年6月版）
- 労働基準法
- 36協定に関する資料
