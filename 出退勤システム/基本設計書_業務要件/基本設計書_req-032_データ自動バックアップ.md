
# 基本設計書

## ドキュメント概要
本基本設計書は、出退勤システムの要件に基づき、システムの基本設計を定義するものである。日本IT業界の標準的な規範に従い、明確かつ構造化された記述を行う。

## システム概要
本システムは、従業員の出退勤時刻を正確に記録・管理するための出退勤システムである。本設計書では、データの自動バックアップ機能について定義する。

## 要件定義
### 要件一覧
| ID | 分類 | 要件名 | 概要 | 利用者 |
|---|---|---|---|---|
| req-032 | セキュリティ・データ管理 | データ自動バックアップ | 重要な勤怠データは定期的に自動でバックアップされ、データ損失のリスクが最小化される。 | システム管理者 |

## 機能設計
### データ自動バックアップ機能 (req-032)
#### 機能概要
システム管理者が設定したスケジュールに基づき、勤怠データを自動的にバックアップする機能を提供する。バックアップデータは、災害対策を考慮し、物理的に異なる場所に保管される。

#### 入力仕様
- **システム設定画面**
  - **バックアップスケジュール**: 選択式（例：毎日、毎週、毎月）
  - **バックアップ時間**: 時刻指定 (HH:MM)
  - **バックアップ先**: 保存先ディレクトリ (例：`/backup/attendance/`)
  - **世代管理**: 保存世代数 (例：3世代)

#### 出力仕様
- **バックアップファイル**
  - ファイル形式：圧縮ファイル (例：.zip, .gz)
  - ファイル名：`attendance_data_YYYYMMDDHHMM.zip` (例：attendance_data_202407261000.zip)
- **ログ出力**
  - バックアップの開始、終了、エラーに関するログを出力する。
  - ログファイル保存先: `/var/log/attendance/backup.log`

#### 処理フロー
1. システム管理者がシステム設定画面でバックアップスケジュール、時間、保存先、世代管理を設定する。
2. 設定されたスケジュールに従い、バックアップ処理が自動的に開始される。
3. バックアップ対象の勤怠データをデータベースから抽出する。
4. 抽出したデータを圧縮ファイルとして指定された保存先に保存する。
5. 世代管理の設定に基づき、古いバックアップファイルを削除する。
6. バックアップの開始、終了、結果に関するログをログファイルに出力する。

#### エラー処理
- **バックアップ先への書き込みエラー**: バックアップ先のディスク容量不足、アクセス権限不足などにより書き込みに失敗した場合、<span style="color:red;">エラーログを出力し、システム管理者に通知する。</span>
- **データベース接続エラー**: データベースへの接続に失敗した場合、<span style="color:red;">エラーログを出力し、システム管理者に通知する。</span>
- **世代管理エラー**: 古いバックアップファイルの削除に失敗した場合、<span style="color:red;">エラーログを出力し、システム管理者に通知する。</span>

## データ設計
### データベース構造
- バックアップ対象データは、勤怠関連テーブル（例：T_ATTENDANCE, T_LEAVE_APPLICATION, T_EMPLOYEE）とする。
- バックアップ履歴テーブル (T_BACKUP_HISTORY)  を設ける（新規）。

#### 【新規】バックアップ履歴テーブル (T_BACKUP_HISTORY)
| 項目名 | データ型 | 説明 | 主キー |
|---|---|---|---|
| backup_id | BIGINT | バックアップID（自動採番） | ○ |
| backup_date | DATETIME | バックアップ実行日時 | |
| backup_file_path | VARCHAR(255) | バックアップファイルパス | |
| status | VARCHAR(2) | ステータス（01:成功, 02:失敗） | |
| error_message | VARCHAR(255) | エラーメッセージ（失敗時） | |

## インターフェース設計
### 内部インターフェース
- **データベース接続**
  - バックアップ対象データの抽出のためにデータベースに接続する。
- **ファイルシステム**
  - バックアップファイルの保存、世代管理のためにファイルシステムにアクセスする。
- **ログ出力**
  - バックアップ処理のログをファイルに出力する。

## 非機能要件
### 性能
- バックアップ処理時間: 業務時間外に完了すること（例：深夜2時～4時の間に完了）。
- バックアップ処理によるシステムへの負荷を最小限に抑えること。

### セキュリティ
- バックアップデータは暗号化して保存する。
- バックアップデータへのアクセス権限はシステム管理者のみに限定する。
- バックアップデータは、本番環境とは異なる物理的な場所に保管する。

## テスト計画
### 単体テスト
- バックアップスケジュールに従い、指定された時間にバックアップ処理が開始されることを確認する。
- バックアップファイルが指定された保存先に作成されることを確認する。
- 世代管理が正しく機能し、古いバックアップファイルが削除されることを確認する。
- バックアップ履歴テーブルにバックアップ処理の結果が記録されることを確認する。

### 結合テスト
- データベースから勤怠データが正しく抽出され、バックアップファイルに保存されることを確認する。
- バックアップデータをリストアし、データが正しく復元されることを確認する。
- バックアップ処理がシステムに与える負荷を測定し、許容範囲内であることを確認する。

## 付録
### 用語集
- **バックアップ**: システムのデータを複製し、データ損失に備えること。
- **リストア**: バックアップデータからデータを復元すること。
- **世代管理**: バックアップファイルを一定期間保存し、古いファイルを削除する仕組み。

### 参考資料
- 日本IT業界標準設計書テンプレート（JISA）
- 出退勤システム要件定義書（2025年6月版）
