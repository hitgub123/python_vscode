# 基本設計書

## ドキュメント概要
本基本設計書は、出退勤システムの要件に基づき、システムの基本設計を定義するものである。日本IT業界の標準的な規範に従い、明確かつ構造化された記述を行う。

| ID | 作成者 | 作成日付 |
|---|---|---|
| req-014 | カエルXX | 2024-05-24 |

## システム概要
本システムは、従業員の勤怠を管理するシステムの一部として、残業時間の自動計上機能を提供する。本機能は、承認された残業申請と実績打刻を基に、残業時間を自動で計算し、勤怠データに反映させる。

## 要件定義
### 要件一覧
| ID | 分類 | 要件名 | 概要 | 利用者 |
|---|---|---|---|---|
| req-014 | 残業管理 | 残業時間自動計上 | 承認された残業時間は、実績（打刻時間）に基づき自動的に勤怠データに計上される。 | 人事部門、管理職 |

## 機能設計
### 残業時間自動計上機能 (req-014)
#### 機能概要
承認済みの残業申請に対し、実際の退勤打刻時間（実績）を基に、その日の残業時間を自動で計算し、日次の勤怠データに計上する夜間バッチ機能。

#### 入力仕様
- **処理対象**:
  - 残業申請テーブル(`T_OVERTIME_APPLICATION`)のステータスが「承認済み」のレコード。
  - 打刻履歴テーブル(`T_ATTENDANCE_LOG`)の対象日の退勤打刻レコード。

#### 出力仕様
- 日次勤怠記録テーブル(`T_DAILY_WORK_RECORD`)の残業時間項目が更新される。
- バッチ処理の実行結果（処理件数、エラー件数）がシステムログに出力される。

#### 処理フロー
1. 夜間バッチ処理が、予め定められたスケジュールで起動する。
2. 「承認済み」の残業申請レコードを検索する。
3. 各申請に対し、対象従業員の対象日の退勤打刻時刻を取得する。
4. 所定終業時刻と退勤打刻時刻の差から、実績残業時間を算出する（休憩時間を考慮）。
5. **実績残業時間**と**申請された残業時間**を比較し、短い方をその日の正式な残業時間として採用する。
6. 算出した残業時間（分）を、日次勤怠記録テーブルの残業時間フィールドに記録する。

#### エラー処理
- **実績データ不足**: <font color="red">対象日に退勤打刻が存在しない、または所定終業時刻より前に打刻されている場合、残業時間は0分として計上し、その旨を警告ログに出力する。</font>

## データ設計
### データベース構造
#### 日次勤怠記録テーブル (T_DAILY_WORK_RECORD) の更新
残業時間を記録するため、カラムを追加または利用する。
| 項目名 | データ型 | 説明 |
|---|---|---|
| work_date | DATE | 勤務日 |
| employee_id | VARCHAR(10) | 従業員ID |
| ... | ... | ... |
| **overtime_minutes** | **INTEGER** | **計上された残業時間（分単位）** |

## インターフェース設計
### 内部インターフェース
- 本機能はサーバー内部で実行されるバッチ処理であり、直接的なAPIエンドポイントは存在しない。OSのスケジューラ（cron等）によって定期的に実行される。

## 非機能要件
### 信頼性
- バッチ処理は冪等性を保証すること。何らかの理由で同じ処理が複数回実行されても、結果が常に同じになるように設計する。

## テスト計画
### シナリオテスト
- 申請時間より実績残業時間が短い場合、実績時間が採用されることを確認する。
- 申請時間より実績残業時間が長い場合、申請時間が上限として採用されることを確認する。
- 退勤打刻がない場合、残業時間が0分として処理されることを確認する。

## 付録
### 用語集
- **実績残業時間**: 所定終業時刻から、実際の退勤打刻時刻までの時間。
- **バッチ処理**: データを一括して処理する方式。