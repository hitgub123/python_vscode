## 基本設計書

| ID      | fun-024                      |
| ------- | ---------------------------- |
| 分類    | シフト管理                   |
| 機能名  | シフト乖離検出アラート機能                   |
| 概要    | 実際の打刻時間と設定されたシフト時間との間に著しい乖離（例：遅刻、早退、無打刻）があった場合に、システムがそれを検出し、管理職に自動通知する。 |
| 利用者  | 管理職                   |
| 作成者  |                               |
| 作成日付 |                               |

### 1. 目的

本機能は、従業員の実際の打刻時間と設定されたシフト時間との間に著しい乖離があった場合に、システムがそれを検出し、管理職に自動通知することを目的とする。

### 2. 適用範囲

本機能は、全従業員の打刻データとシフトデータに適用される。

### 3. 入力

#### 入力項目

| 項目       | 内容                  | 型       | 必須   | 備考                                                                                       |
| ---------- | --------------------- | -------- | ------ | ------------------------------------------------------------------------------------------ |
| 従業員ID   | 従業員を識別するID     | 文字列   | 必須   | 社員番号など                                                                               |
| 打刻時刻   | 実際に出退勤を行った日時   | 日時型   | 必須   |                                                                                            |
| シフト開始時刻 | 設定されたシフトの開始時刻 | 日時型   | 必須   |                                                                                            |
| シフト終了時刻 | 設定されたシフトの終了時刻 | 日時型   | 必須   |                                                                                            |

#### 業務Check

| 項目       | 内容                                                                                   |
| ---------- | ------------------------------------------------------------------------------------ |
| 従業員ID   | 社員マスタに登録されているIDであること。                                                              |
| 打刻時刻   | 過去の日時であること。                                                            |
| シフト開始時刻 | シフトマスタに登録されているシフトの開始時刻であること。                                                              |
| シフト終了時刻 | シフトマスタに登録されているシフトの終了時刻であること。                                                              |

### 4. 出力

| 項目       | 内容                     | 型       | 備考                               |
| ---------- | ------------------------ | -------- | ---------------------------------- |
| アラート通知 | 乖離検出時に送信される通知 |  | システム内通知、メールなど           |
| 従業員ID   | 乖離が検出された従業員のID    | 文字列   | 通知の宛先を特定するために使用                 |
| 乖離の種類 | 遅刻、早退、無打刻などの乖離の種類 | 文字列   |                                    |
| 乖離時間   | 実際の打刻時間とシフト時間との差 | 時間型   |                                    |

### 5. 処理詳細

1.  システムは、従業員ごとの打刻データとシフトデータを取得する。
2.  打刻データとシフトデータを比較し、乖離（遅刻、早退、無打刻など）を検出する。
3.  乖離が検出された場合、以下の情報を基にアラート通知を生成する。
    *   従業員ID
    *   乖離の種類
    *   乖離時間
4.  生成されたアラート通知を、該当する管理職に送信する（システム内通知、メールなど）。
5.  アラート通知の送信履歴を記録する。

### 6. 例外処理

| 条件                                                                    | 対応                                                                                                                       |
| ----------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------- |
| 入力データエラー（従業員IDが存在しない、シフトデータが存在しないなど）           | <span style="color:red;">エラーログを出力し、処理を中断する。システム管理者に通知する。</span>                                         |
| 乖離検出処理中にエラーが発生した場合                                                        | <span style="color:red;">エラーログを出力し、処理を中断する。システム管理者に通知する。</span>                         |
| アラート通知の送信に失敗した場合                                  | <span style="color:red;">エラーログを出力し、再送処理を行う。再送に失敗した場合は、システム管理者に通知する。</span>                         |
| 同一従業員に対して短時間に多数のアラートが発生した場合 | 一定時間内に発生するアラートの数を制限し、過剰な通知を防ぐ。<br><span style="color:red;">制限を超えた場合はエラーログを出力。</span> |

### 7. 画面設計

*   アラート通知画面（管理職向け）：
    *   乖離が発生した従業員のリスト
    *   各従業員の詳細な乖離情報（種類、時間など）
    *   アラート通知の履歴

### 8. その他

*   アラートの閾値：遅刻、早退の許容時間などを設定可能とする。
*   通知方法：システム内通知、メールなど、複数の通知方法を選択可能とする。
*   ログ：全てのアラート検出および通知処理をログに記録する。
